"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function replaceAll(e,t,n){for(;-1!==e.indexOf(t);)e=e.replace(t,n);return e}function f(e){var t=e.toLowerCase().replace("table:","").trim(),n=_fs2["default"].readFileSync(t,"utf-8");return csv2json(n)}function csv2json(e){e=replaceAll(e,"\r","");var t=e.split("\n"),n=[],a=t.shift().split(";");return t.pop(),t.forEach(function(e){e=e.split(";");var t={};a.forEach(function(n,a){t[n]=e[a],0===t[n].indexOf("table:")&&(t[n]=f(t[n]))}),n.push(_utf82["default"].enconde(t))}),n}function buildAttachment(e,t){e=e?e.split(","):[];var n=new _easyZip2["default"].EasyZip,a=e[0]||!1;if(a){var i;!function(){var l=a[a.length-1],o=Math.round(1e6*Math.random()),r=_path3["default"].join(__dirname,"../tmp/"+o+".zip");"\\"===l||"/"===l?n.zipFolder(a,function(){return n.writeToFile(r,function(){t&&t([r])})}):(i=[],e.forEach(function(e){e=(e||"").trim();var t=e.split("\\"),n=t[t.length-1].split(".")[1];n&&i.push(e)}),t&&t(i))}()}else t&&t(null)}function clear(e){e&&e.forEach(function(e){(e.indexOf("/tmp/")>=0||e.indexOf("\\tmp\\")>=1)&&_fs2["default"].unlink(e,function(e){e&&console.log(e)})})}function sendMailing(e){console.log("Disparando emails de "+e),_fs2["default"].readFile(e,"utf-8",function(e,t){var n=csv2json(t);console.log(n),n.forEach(function(e){e.to=replaceAll(e.to," ","").split(",");var t=e.to;delete e.to;var n=e.subject;delete e.subject;var a=e.template;delete e.template;var i=e;buildAttachment(e.attachments,function(e){new _mailClass2["default"](_configJson2["default"].email.user,t,n,i,e,a).send(_smtp2["default"],function(t,n){t?console.log(t):console.log("email send at "+n.header.date),clear(e)})})})})}Object.defineProperty(exports,"__esModule",{value:!0});var _fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path2=require("path"),_path3=_interopRequireDefault(_path2),_easyZip=require("easy-zip"),_easyZip2=_interopRequireDefault(_easyZip),_utf8=require("utf-8"),_utf82=_interopRequireDefault(_utf8),_configJson=require("../config.json"),_configJson2=_interopRequireDefault(_configJson),_mailClass=require("./mail.class"),_mailClass2=_interopRequireDefault(_mailClass),_smtp=require("./smtp"),_smtp2=_interopRequireDefault(_smtp);exports["default"]={mailing:function(e){console.log("\n**HERMES INIT**\n"),e=_path3["default"].resolve(process.cwd(),e),sendMailing(e)},all:function(){console.log("\n**HERMES INIT**\n");var e=_path3["default"].resolve(_configJson2["default"].files.base),t=_fs2["default"].readdirSync(e);t.forEach(function(t){var n=_path3["default"].join(e,""+t);sendMailing(n)})}},module.exports=exports["default"];